# 分布式服务

## 微服务架构发展历程*

不管是互联网，还是银行、证券、保险，业务越来越复杂，数据越来越多。
系统对性能、稳定性，一致性，可用性，扩展性，可维护性，要求越来越高。

单体架构

简单单体模式是最简单的架构风格，所有的代码全都在一个项目中。这样研发团队的任何一个人都可以随时修改任意的一段代码，或者增加一些新的代码。

垂直架构

分层是一个典型的对复杂系统（不仅仅是软件）进行结构化思考和抽象聚合的通用性办法，也符合金字塔原理。
MVC是一个非常常见的3层（3-Tier）结构架构模式。

SOA架构

面向服务架构（SOA）是一种建设企业IT生态系统的架构指导思想。SOA的关注点是服务。服务最基本的业务功能单元，由平台中立性的接口契约来定义。

微服务架构

微服务架构风格，以实现一组微服务的方式来开发一个独立的应用系统的方法。其中每个小微服务都运行在自己的进程中，一般采用HTTP资源API这样轻量的机制相互通信。

### 微服务发展历程--1.响应式微服务

响应式编程是一个专注于数据流和变化传递的异步编程范式。 -- 维基百科

响应式宣言

即时响应性  可恢复性  弹性  消息驱动

### 微服务发展历程--2.服务网格与云原生

将服务间的网络通信层及其控制策略下沉到基础设施，就形成了所谓的“服务网格”技术。
通过微服务、容器化、持续交付、Devops等技术，组成了所谓的“元原生”体系。

### 微服务发展历程--3.数据库网格

### 微服务发展历程--4.单元化架构

以单元为组织架构，以单元化部署为调度单位。

每个单元，是一个五脏俱全的缩小版整站，它是全能的，因为部署了所有应用；但它不是全量的，因为只能操作一部分数据。能够单元化的系统，很容易在多机房中部署，因为可以轻易地把几个单元部署在一个机房，而把另外几个部署在其他机房。通过在业务入口处设置一个流量调配器，可以调整业务流量在单元之间的比例。

微服务
MicroServices
服务网格
ServiceMesh
数据库网格
DatabaseMesh
云原生
Cloud-Native

单元化架构
Cell Architecture

## 微服务架构应用场景*

### 什么时候用微服务呢

微服务应用在复杂度低的情况下，生产力反而比单体架构低
在复杂度高的地方，情况恰恰相反
随着复杂度升高，单体架构的生产力快速下降，而微服务相对平稳，
为什么？

大规模复杂业务系统的架构升级与中台建设

### 怎么应用微服务架构-I6I

准备阶段

调研I,分析A,规划P,组织O

实施阶段

拆分S,部署D,治理G,改进I

## 微服务架构最佳实践*

### 六大最佳实践

1. 遗留系统改造

功能剥离、数据解耦
自然演进、逐步拆分
小步快跑、快速迭代
灰度发布、谨慎试错
提质量线、还技术债

2. 恰当粒度拆分

拆分原则：
- 高内聚低耦合
- 不同阶段拆分要点不同

3. 扩展立方体

扩展立方体：
- 水平复制：复制系统
- 功能解耦：拆分业务
- 数据分区：切分数据
单元化架构的基础

+特性开关 +容错设计

4. 自动化管理

- 自动化测试
- 自动化部署
- 自动化运维
降低服务拆分带来的复杂性
提升测试、部署、运维效率

注：当你引入了一个你不懂的问题，你就引入了两个问题

5. 分布式事务

幂等/去重/补偿
慎用分布式事务！

6. 完善监控体系

监控与运维：
1.业务监控
2.系统监控
3.容量规划
4.报警预警
5.运维流程
6.故障处理

+Devops +SRE

## Spring Cloud技术体系*

- Config/Eureka/Consul
- Zuul/Zuul2/Spring Cloud Gateway
- Feign/Ribbon

Feign的核心功能就是，作为HTTP Client访问REST服务接口。
优势在于：
1、全都基于注解，简单方便
2、跟XXTemplate一样，内置了简化操作，OOP
3、跟其他组件，ribbon，hytrix联合使用

Ribbon是用于云环境的一个客户端内部通信（IPC）库。
特性：
1、负载均衡
2、容错
3、多协议支持(HTTP, TCP, UDP)，特别是异步和反应式下
4、缓存和批处理

- Hytrix/Alibaba Sentinel

shiro

## 微服务相关框架与工具

### 相关工具-APM

APM：应用性能监控
- Apache Skywalking
- Pinpoint
- Zipkin
- Jaeger
监控
- ELK
- promethus+Grafana
MQ+时序数据库
(InfluxDB/openTSDB等)

可观测性：
- logging
- tracing
- metrics

### 相关工具-权限控制

最核心的3A（其他：资源管理、安全加密等）：
- Authc: Authentication
- Authz: Authorization
- Audit
CAS+SSO(TGT、ST)
JWT/Token, OAuth2.0
SpringSecurity, Apache Shiro

### 相关工具-数据处理

1、读写分离与高可用HA：
2、分库分表Sharding：
3、分布式事务DTX：
4、数据迁移Migration：
5、数据集群扩容Scaling：
6、数据操作审计Audit：

### 相关工具-网关与通信

1、流量网关与WAF(Nginx/OR/Kong/Apisix)
2、业务网关(Zuul/Zuul2/SCG)
3、REST与其他协议之争（websocket/actor/rsocket/mq...）

## 总结回顾与作业实践